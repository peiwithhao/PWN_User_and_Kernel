é—²ç€ä¹Ÿæ˜¯é—²ç€ï¼Œå¹¶ä¸”ååˆ†å´‡æ•¬å†…æ ¸pwnçš„å­¦ä¹ ï¼Œæ‰€ä»¥å…ˆè®°å½•ä¸€ä¸‹linux kernelçš„ç¯å¢ƒæ­å»ºï¼Œè¿™é‡Œä¸»è¦ä¹Ÿæ˜¯è·Ÿç€arttnab3å¸ˆå‚…æ¥ä¸€æ­¥ä¸€æ­¥èµ°çš„
> æ³¨: è¿™é‡Œçš„ä¸»æœºç¯å¢ƒä¸ºUbuntu20.04 
# Linux Kernel ç¯å¢ƒæ­å»º
## å®‰è£…ä¾èµ–
```
$ sudo apt-get update
$ sudo apt-get install git fakeroot build-essential ncurses-dev xz-utils qemu flex libncurses5-dev fakeroot build-essential ncurses-dev xz-utils libssl-dev bc bison libglib2.0-dev libfdt-dev libpixman-1-dev zlib1g-dev libelf-dev
```
## è·å–å†…æ ¸é•œåƒï¼ˆbzImageï¼‰
æœ‰å¦‚ä¸‹ä¸‰ç§æ–¹å¼
+ ä¸‹è½½å†…æ ¸æºç åç¼–è¯‘
+ ç›´æ¥ä¸‹è½½ç°æˆçš„çš„å†…æ ¸é•œåƒ
+ ç›´æ¥ä½¿ç”¨è‡ªå·±ç³»ç»Ÿçš„é•œåƒ
```
$ wget https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.11.tar.xz
```

æˆ‘æ±‚ç¨³ï¼Œè·Ÿç€å¸ˆå‚…æ¥ï¼Œä»–æ˜¯æˆ‘çš„ç¥ï¼Œé‡‡å–æ³•ä¸€
## æ–¹æ³•ä¸€ï¼šè‡ªè¡Œç¼–è¯‘å†…æ ¸æºç 
### 1.è·å–å†…æ ¸æºç 
å‰å¾€[Linux Kernel Archive](https://www.kernel.org/)ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„å†…æ ¸æºç ï¼Œè¿™é‡Œé€‰ç”¨5.11è¿™ä¸ªç‰ˆæœ¬çš„å†…æ ¸é•œåƒã€‚
```
$ wget https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.11.tar.xz
```

### 2.é…ç½®ç¼–è¯‘é€‰é¡¹
è§£å‹æˆ‘ä»¬ä¸‹è½½æ¥çš„å†…æ ¸æºç 
```
$ tar -xvf linux-5.11.tar.xz
```
å®Œæˆåè¿›å…¥æ–‡ä»¶å¤¹å†…ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å¼€å§‹é…ç½®ç¼–è¯‘é€‰é¡¹
```
$ make menuconfig
```
![](https://i.loli.net/2021/02/21/YXVQhel4vjMHDSa.png)
ä¿è¯å‹¾é€‰å¦‚ä¸‹é…ç½®ï¼ˆé»˜è®¤éƒ½æ˜¯å‹¾é€‰äº†çš„ï¼‰ï¼š

+ Kernel hacking â€”> Kernel debugging
+ Kernel hacking â€”> Compile-time checks and compiler options â€”> Compile the kernel with debug info
+ Kernel hacking â€”> Generic Kernel Debugging Instruments â€“> + + KGDB: kernel debugger
+ kernel hacking â€”> Compile the kernel with frame pointers
ä¸€èˆ¬æ¥è¯´ä¸éœ€è¦æœ‰ä»€ä¹ˆæ”¹åŠ¨ï¼Œç›´æ¥ä¿å­˜é€€å‡ºå³å¯ï¼Œä½ ä¹Ÿå¯ä»¥æ ¹æ®ä½ çš„éœ€æ±‚æ‰‹åŠ¨æ›´æ”¹ä¸€äº›ç¼–è¯‘é€‰é¡¹

é€šå¸¸ä¿å­˜çš„è·¯å¾„åœ¨å½“å‰ç›®å½•ä¸‹çš„ .config æ–‡ä»¶ä¸­ï¼Œå¦‚æœä½ åœ¨ç”Ÿæˆé…ç½®æ–‡ä»¶åæ‰æƒ³èµ·æ¥å¿˜äº†æ”¹æŸä¸ªé€‰é¡¹ä¹Ÿå¯ä»¥ç›´æ¥ç¼–è¾‘è¿™ä¸ªæ–‡ä»¶

--- 
è‡ªå·±ç¼–è¯‘è¿™é‡Œå‡ºäº†ç‚¹ç½‘ç»œé—®é¢˜ï¼Œå’±ä»¬æ¢ä¸€ä¸ªæ³•å­ï¼Œä»¥åæˆ‘å†è¡¥å…¨
### æ–¹æ³•äºŒï¼šä¸‹è½½ç°æœ‰å†…æ ¸é•œåƒ
ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹ç°æœ‰çš„å†…æ ¸é•œåƒ
```
$ sudo apt search linux-image- 
```
è¿™é‡Œé‡‡ç”¨5.8è¿›è¡Œç¤ºèŒƒ
```
$ sudo apt download linux-image-5.8.0-43-generic
```
ä¸‹è½½ä¸‹æ¥æ˜¯ä¸€ä¸ªdebæ–‡ä»¶ï¼Œè§£å‹
```
$ dpkg -X ./linux-image-5.8.0-43-generic_5.8.0-43.49~20.04.1_amd64.deb extract
./
./boot/
./boot/vmlinuz-5.8.0-43-generic
./usr/
./usr/share/
./usr/share/doc/
./usr/share/doc/linux-image-5.8.0-43-generic/
./usr/share/doc/linux-image-5.8.0-43-generic/changelog.Debian.gz
./usr/share/doc/linux-image-5.8.0-43-generic/copyright
```
å…¶ä¸­çš„./boot/vmlinuz-5.8.0-43-genericä¾¿æ˜¯bzImageå†…æ ¸é•œåƒæ–‡ä»¶

### æ–¹æ³•ä¸‰ï¼šç›´æ¥ç”¨è‡ªå·±ç³»ç»Ÿçš„é•œåƒ
ä¸€èˆ¬ä½äº/boot/ç›®å½•ä¸‹ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ‹¿å‡ºæ¥ç”¨
## ä½¿ç”¨ busybox æ„å»ºæ–‡ä»¶ç³»ç»Ÿ
BusyBox æ˜¯ä¸€ä¸ªé›†æˆäº†ä¸‰ç™¾å¤šä¸ªæœ€å¸¸ç”¨Linuxå‘½ä»¤å’Œå·¥å…·çš„è½¯ä»¶ï¼ŒåŒ…å«äº†ä¾‹å¦‚lsã€catå’Œechoç­‰ä¸€äº›ç®€å•çš„å·¥å…·ï¼Œæˆ‘ä»¬å°†ç”¨ busybox ä¸ºæˆ‘ä»¬çš„å†…æ ¸æä¾›ä¸€ä¸ªåŸºæœ¬çš„ç¼–è¯‘busybox
I.è·å–busyboxæºç ç”¨æˆ·ç¯å¢ƒ
### 1.ç¼–è¯‘busybox
1. è·å–busyboxæºç 
åœ¨[busybox.net](https://busybox.net/downloads/)ä¸‹è½½è‡ªå·±æƒ³è¦çš„ç‰ˆæœ¬ï¼Œè¿™é‡Œé€‰ç”¨busybox-1.33.0.tar.bz2è¿™ä¸ªç‰ˆæœ¬
```
$ wget https://busybox.net/downloads/busybox-1.33.0.tar.bz2
```
è§£å‹
```
$ tar -jxvf busybox-1.33.0.tar.bz2
```
2. ç¼–è¯‘busyboxæºç 
è¿›å…¥é…ç½®ç•Œé¢
```
$ make menuconfig
```
å‹¾é€‰Settings â€”> Build static binary file (no shared lib)
> è‹¥æ˜¯ä¸å‹¾é€‰åˆ™éœ€è¦å•ç‹¬é…ç½®libï¼Œæ¯”è¾ƒéº»çƒ¦
  

æ¥ä¸‹æ¥å°±æ˜¯ç¼–è¯‘äº†ï¼Œé€Ÿåº¦ä¼šæ¯”ç¼–è¯‘å†…æ ¸å¿«å¾ˆå¤š
```
$ make install
```
ç¼–è¯‘å®Œæˆåä¼šç”Ÿæˆä¸€ä¸ª_installç›®å½•ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†ä¼šç”¨å®ƒæ¥æ„å»ºæˆ‘ä»¬çš„ç£ç›˜é•œåƒ
  
### å»ºç«‹æ–‡ä»¶ç³»ç»Ÿ
1. åˆå§‹åŒ–æ–‡ä»¶ç³»ç»Ÿ
 ä¸€äº›ç®€å•çš„åˆå§‹åŒ–æ“ä½œâ€¦æ— éä¹Ÿå°±æ˜¯æ„å»ºå‡ºåŸºæœ¬çš„æ–‡ä»¶å¤¹ç­‰
 ```
 $ cd _install
$ mkdir -pv {bin,sbin,etc,proc,sys,home,lib64,lib/x86_64-linux-gnu,usr/{bin,sbin}}
$ touch etc/inittab
$ mkdir etc/init.d
$ touch etc/init.d/rcS
$ chmod +x ./etc/init.d/rcS
 ```
2. é…ç½®åˆå§‹åŒ–è„šæœ¬
é¦–å…ˆé…ç½®etc/inttabï¼Œå†™å…¥å¦‚ä¸‹å†…å®¹ï¼š
```
::sysinit:/etc/init.d/rcS
::askfirst:/bin/ash
::ctrlaltdel:/sbin/reboot
::shutdown:/sbin/swapoff -a
::shutdown:/bin/umount -a -r
::restart:/sbin/init
```
åœ¨ä¸Šé¢çš„æ–‡ä»¶ä¸­æŒ‡å®šäº†ç³»ç»Ÿåˆå§‹åŒ–è„šæœ¬ï¼Œå› æ­¤æ¥ä¸‹æ¥é…ç½®etc/init.d/rcSï¼Œå†™å…¥å¦‚ä¸‹å†…å®¹ï¼š
```
#!/bin/sh
mount -t proc none /proc
mount -t sys none /sys
/bin/mount -n -t sysfs none /sys
/bin/mount -t ramfs none /dev
/sbin/mdev -s
```
ä¸»è¦æ˜¯é…ç½®å„ç§ç›®å½•çš„æŒ‚è½½

ä¹Ÿå¯ä»¥åœ¨æ ¹ç›®å½•ä¸‹åˆ›å»ºinitæ–‡ä»¶ï¼Œå†™å…¥å¦‚ä¸‹å†…å®¹ï¼š
```
#!/bin/sh

mount -t proc none /proc
mount -t sysfs none /sys
mount -t devtmpfs devtmpfs /dev

exec 0</dev/console
exec 1>/dev/console
exec 2>/dev/console

echo -e "\nBoot took $(cut -d' ' -f1 /proc/uptime) seconds\n"
setsid cttyhack setuidgid 1000 sh

umount /proc
umount /sys
poweroff -d 0  -f
```
åˆ«å¿˜äº†æ·»åŠ å¯æ‰§è¡Œæƒé™ï¼š
```
$ chmod +x ./init
```
3. é…ç½®ç”¨æˆ·ç»„
```
$ echo "root:x:0:0:root:/root:/bin/sh" > etc/passwd
$ echo "ctf:x:1000:1000:ctf:/home/ctf:/bin/sh" >> etc/passwd
$ echo "root:x:0:" > etc/group
$ echo "ctf:x:1000:" >> etc/group
$ echo "none /dev/pts devpts gid=5,mode=620 0 0" > etc/fstab
```
åœ¨è¿™é‡Œå»ºç«‹äº†ä¸¤ä¸ªç”¨æˆ·ç»„rootå’Œctfï¼Œä»¥åŠä¸¤ä¸ªç”¨æˆ·rootå’Œctf
4. é…ç½®glibcåº“
å°†éœ€è¦çš„åŠ¨æ€é“¾æ¥åº“æ‹·åˆ°ç›¸åº”ä½ç½®å³å¯
> è¿™é‡Œå¸ˆå‚…æ²¡å¼„æˆ‘å°±ä¹Ÿä¸å¼„ï¼Œå“¼ğŸ˜•

### 3.æ‰“åŒ…æ–‡ä»¶ç³»ç»Ÿä¸ºé•œåƒæ–‡ä»¶
ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ‰“åŒ…æ–‡ä»¶ç³»ç»Ÿ
```
$ find . | cpio -o --format=newc > ../../rootfs.cpio
```
ä¹Ÿå¯ä»¥é‡‡ç”¨å¦‚ä¸‹å†™æ³•
```
$ find . | cpio -o -H newc > ../core.cpio
```
æ³¨æ„è¿™é‡Œçš„æ‰“åŒ…ä½ç½®å¯ä»¥éšæ„
### å‘æ–‡ä»¶ç³»ç»Ÿä¸­æ·»åŠ æ–‡ä»¶
è‹¥æ˜¯æˆ‘ä»¬åç»­éœ€è¦å‘æ–‡ä»¶ç³»ç»Ÿä¸­è¡¥å……ä¸€äº›å…¶ä»–çš„æ–‡ä»¶ï¼Œå¯ä»¥é€‰æ‹©åœ¨åŸå…ˆçš„_installæ–‡ä»¶å¤¹ä¸­æ·»åŠ ï¼ˆä¸è¿‡è¿™æ ·çš„è¯è‹¥æ˜¯é…ç½®å¤šä¸ªæ–‡ä»¶ç³»ç»Ÿåˆ™ä¼šå˜å¾—å¾ˆæ··ä¹±ï¼‰ï¼Œä¹Ÿå¯ä»¥è§£å‹æ–‡ä»¶ç³»ç»Ÿé•œåƒåæ·»åŠ æ–‡ä»¶å†é‡æ–°è¿›è¡Œæ‰“åŒ…

1. è§£å‹ç£ç›˜é•œåƒ
```
$ cpio -idv < ./rootfs.cpio
```
2. é‡æ‰“åŒ…ç£ç›˜é•œåƒ
å’Œæ‰“åŒ…ç£ç›˜é•œåƒçš„å‘½ä»¤ä¸€æ ·
```
$ find . | cpio -o --format=newc > ../new_rootfs.cpio
```

## ä½¿ç”¨qemuè¿è¡Œå†…æ ¸
å†²å†²å†²ï¼Œæ¿€åŠ¨çš„å¿ƒé¢¤æŠ–çš„æ‰‹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è‡ªå·±é…ç½®çš„æ–‡ä»¶ç³»ç»Ÿä¸å†…æ ¸è·‘èµ·æ¥
### é…ç½®å¯åŠ¨è„šæœ¬
é¦–å…ˆå°†å…ˆå‰çš„bzImageå’Œrootfs.cpioæ”¾åˆ°åŒä¸€ä¸ªç›®å½•ä¸‹
æ¥ä¸‹æ¥ç¼–å†™å¯åŠ¨è„šæœ¬
```
#!/bin/sh
qemu-system-x86_64 \
    -m 128M \
    -kernel ./bzImage \
    -initrd  ./rootfs.cpio \
    -monitor /dev/null \
    -append "root=/dev/ram rdinit=/sbin/init console=ttyS0 oops=panic panic=1 loglevel=3 quiet nokaslr" \
    -cpu kvm64,+smep \
    -smp cores=2,threads=1 \
    -netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \
    -nographic \
    -s
```
è¿™é‡Œæ–‡ä»¶åä½¿ç”¨boot.sh
éƒ¨åˆ†å‚æ•°è¯´æ˜å¦‚ä¸‹ï¼š

+ -mï¼šè™šæ‹Ÿæœºå†…å­˜å¤§å°
+ -kernelï¼šå†…å­˜é•œåƒè·¯å¾„
+ -initrdï¼šç£ç›˜é•œåƒè·¯å¾„
+ -appendï¼šé™„åŠ å‚æ•°é€‰é¡¹
+ nokalsrï¼šå…³é—­å†…æ ¸åœ°å€éšæœºåŒ–ï¼Œæ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œè°ƒè¯•
+ rdinitï¼šæŒ‡å®šåˆå§‹å¯åŠ¨è¿›ç¨‹ï¼Œ/sbin/initè¿›ç¨‹ä¼šé»˜è®¤ä»¥/etc/init.d/rcSä½œä¸ºå¯åŠ¨è„šæœ¬
+ loglevel=3 & quietï¼šä¸è¾“å‡ºlog
+ console=ttyS0ï¼šæŒ‡å®šç»ˆç«¯ä¸º/dev/ttyS0ï¼Œè¿™æ ·ä¸€å¯åŠ¨å°±èƒ½è¿›å…¥ç»ˆç«¯ç•Œé¢
+ -monitorï¼šå°†ç›‘è§†å™¨é‡å®šå‘åˆ°ä¸»æœºè®¾å¤‡/dev/nullï¼Œè¿™é‡Œé‡å®šå‘è‡³nullä¸»è¦æ˜¯é˜²æ­¢CTFä¸­è¢«äººç»™å·äº†qemuæ‹¿flag
+ -cpuï¼šè®¾ç½®CPUå®‰å…¨é€‰é¡¹ï¼Œåœ¨è¿™é‡Œå¼€å¯äº†smepä¿æŠ¤
+ -sï¼šç›¸å½“äº-gdb tcp::1234çš„ç®€å†™ï¼ˆä¹Ÿå¯ä»¥ç›´æ¥è¿™ä¹ˆå†™ï¼‰ï¼Œåç»­æˆ‘ä»¬å¯ä»¥é€šè¿‡gdbè¿æ¥æœ¬åœ°ç«¯å£è¿›è¡Œè°ƒè¯•

è¿è¡Œboot.sh,æˆ‘é€ï¼Œæ— æ•Œ~~
![](http://imgsrc.baidu.com/super/pic/item/6d81800a19d8bc3e7253960bc78ba61ea9d3459c.jpg)
è¿™é‡Œé‡åˆ°ä¸€æ¡æŠ¥é”™ä¿¡æ¯ï¼š
```
mount: mounting none on /sys failed: No such device
```
åç­‰å¸ˆå‚…è§£ç­”
